<h1 class="text-3xl font-bold mb-4 text-white">
  {{ movie.title }} ({{ movie.year }})
</h1>

<div class="mb-4">
  <p class="text-gray-300 text-sm">
    {{ movie.synopsis }}
  </p>
</div>

{% with default_track=movie.audio_tracks.first %}
  <div class="mb-4">
    <label for="audioSelect" class="block text-sm font-medium text-gray-200 mb-1">
      Pista de audio
    </label>
    <select id="audioSelect"
            class="bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm text-gray-100">
      {% for track in movie.audio_tracks.all %}
        <option value="{{ track.audio_file.url }}"
                {% if track.is_default or forloop.first %}selected{% endif %}>
          {{ track.label }} ({{ track.get_language_display }})
          {% if track.is_ai_generated %} [IA]{% endif %}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="space-y-2">
    <video id="movieVideo"
           class="w-full max-w-4xl rounded-lg border border-gray-700 bg-black"
           controls
           preload="metadata"
           muted>
      <source src="{{ movie.video_file.url }}" type="video/mp4">
      Tu navegador no soporta v√≠deo HTML5.
    </video>

    <!-- Audio externo -->
    {% if default_track %}
      <audio id="movieAudio">
        <source src="{{ default_track.audio_file.url }}">
      </audio>
    {% endif %}
  </div>
{% endwith %}

<script>
  const video = document.getElementById('movieVideo');
  const audio = document.getElementById('movieAudio');
  const select = document.getElementById('audioSelect');

  if (video && audio) {
    // Sincronizar play/pause
    video.addEventListener('play', () => {
      audio.currentTime = video.currentTime;
      audio.play().catch(() => {});
    });

    video.addEventListener('pause', () => {
      audio.pause();
    });

    video.addEventListener('seeking', () => {
      audio.currentTime = video.currentTime;
    });

    video.addEventListener('ratechange', () => {
      audio.playbackRate = video.playbackRate;
    });

    // Cambio de pista
    if (select) {
      select.addEventListener('change', function () {
        const newSrc = this.value;
        const currentTime = video.currentTime || 0;
        const wasPlaying = !video.paused;

        audio.pause();
        audio.src = newSrc;
        audio.load();

        audio.addEventListener('loadedmetadata', function handler() {
          audio.removeEventListener('loadedmetadata', handler);
          if (currentTime > 0 && currentTime < audio.duration) {
            audio.currentTime = currentTime;
          }
          if (wasPlaying) {
            audio.play().catch(() => {});
          }
        });
      });
    }
  }
</script>
